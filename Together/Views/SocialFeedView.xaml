<UserControl x:Class="Together.Presentation.Views.SocialFeedView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:controls="clr-namespace:Together.Presentation.Controls"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="800">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header with Refresh Button -->
        <Border Grid.Row="0" 
                Background="{DynamicResource MaterialDesignPaper}"
                BorderBrush="{DynamicResource MaterialDesignDivider}"
                BorderThickness="0,0,0,1"
                Padding="16,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                          Text="Social Feed"
                          Style="{StaticResource MaterialDesignHeadline5TextBlock}"
                          VerticalAlignment="Center"/>

                <Button Grid.Column="1"
                        Command="{Binding RefreshCommand}"
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Refresh Feed"
                        IsEnabled="{Binding IsRefreshing, Converter={StaticResource InverseBooleanConverter}}">
                    <materialDesign:PackIcon Kind="Refresh" 
                                            Width="24" 
                                            Height="24"/>
                </Button>
            </Grid>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <!-- Loading Indicator -->
            <ProgressBar IsIndeterminate="True"
                        Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                        VerticalAlignment="Top"
                        Height="4"/>

            <!-- Error Message -->
            <Border Background="{DynamicResource MaterialDesignPaper}"
                    Padding="16"
                    Margin="16"
                    CornerRadius="4"
                    Visibility="{Binding ErrorMessage, Converter={StaticResource StringToVisibilityConverter}}"
                    VerticalAlignment="Top">
                <StackPanel>
                    <materialDesign:PackIcon Kind="AlertCircle" 
                                            Width="48" 
                                            Height="48"
                                            Foreground="{DynamicResource MaterialDesignValidationErrorBrush}"
                                            HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding ErrorMessage}"
                              TextWrapping="Wrap"
                              Foreground="{DynamicResource MaterialDesignValidationErrorBrush}"
                              HorizontalAlignment="Center"
                              Margin="0,8,0,0"/>
                </StackPanel>
            </Border>

            <!-- Feed Content -->
            <ScrollViewer VerticalScrollBarVisibility="Auto"
                         HorizontalScrollBarVisibility="Disabled"
                         Visibility="{Binding ErrorMessage, Converter={StaticResource StringToVisibilityConverter}, ConverterParameter=Inverse}">
                <StackPanel>
                    <!-- Suggested Users Section (shown when no posts) -->
                    <Border Background="{DynamicResource MaterialDesignPaper}"
                            Margin="16,16,16,8"
                            Padding="16"
                            CornerRadius="8"
                            Visibility="{Binding ShowSuggestedUsers, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <StackPanel>
                            <TextBlock Text="Suggested Users to Follow"
                                      Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                                      Margin="0,0,0,16"/>

                            <TextBlock Text="Start following users to see their posts in your feed!"
                                      Style="{StaticResource MaterialDesignBody2TextBlock}"
                                      Foreground="{DynamicResource MaterialDesignBodyLight}"
                                      Margin="0,0,0,16"
                                      TextWrapping="Wrap"/>

                            <ItemsControl ItemsSource="{Binding SuggestedUsers}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="{DynamicResource MaterialDesignDivider}"
                                               BorderThickness="0,0,0,1"
                                               Padding="0,8">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <!-- Profile Picture -->
                                                <Border Grid.Column="0"
                                                       Width="48"
                                                       Height="48"
                                                       CornerRadius="24"
                                                       Background="{DynamicResource MaterialDesignDivider}"
                                                       Margin="0,0,12,0">
                                                    <Border.Clip>
                                                        <EllipseGeometry Center="24,24" RadiusX="24" RadiusY="24"/>
                                                    </Border.Clip>
                                                    <Grid>
                                                        <Image Source="{Binding ProfilePictureUrl}"
                                                              Stretch="UniformToFill"
                                                              Visibility="{Binding ProfilePictureUrl, Converter={StaticResource StringToVisibilityConverter}}"/>
                                                        <TextBlock Text="{Binding Username, Converter={StaticResource FirstLetterConverter}}"
                                                                  FontSize="20"
                                                                  FontWeight="SemiBold"
                                                                  HorizontalAlignment="Center"
                                                                  VerticalAlignment="Center"
                                                                  Visibility="{Binding ProfilePictureUrl, Converter={StaticResource StringToVisibilityConverter}, ConverterParameter=Inverse}"/>
                                                    </Grid>
                                                </Border>

                                                <!-- User Info -->
                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Username}"
                                                              Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                                              FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding Bio}"
                                                              Style="{StaticResource MaterialDesignBody2TextBlock}"
                                                              Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                              TextTrimming="CharacterEllipsis"
                                                              MaxWidth="300"
                                                              Visibility="{Binding Bio, Converter={StaticResource StringToVisibilityConverter}}"/>
                                                </StackPanel>

                                                <!-- Follow Button -->
                                                <Button Grid.Column="2"
                                                       Content="Follow"
                                                       Style="{StaticResource MaterialDesignOutlinedButton}"
                                                       VerticalAlignment="Center"
                                                       Padding="16,4"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>

                    <!-- Posts List with Virtualization -->
                    <ItemsControl ItemsSource="{Binding Posts}"
                                 VirtualizingPanel.IsVirtualizing="True"
                                 VirtualizingPanel.VirtualizationMode="Recycling">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <VirtualizingStackPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <controls:PostCard DataContext="{Binding}" 
                                                  Margin="16,8"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Load More Button -->
                    <Button Command="{Binding LoadMoreCommand}"
                           Style="{StaticResource MaterialDesignOutlinedButton}"
                           Margin="16,16,16,32"
                           HorizontalAlignment="Center"
                           Visibility="{Binding HasMorePosts, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="ChevronDown" 
                                                    VerticalAlignment="Center"
                                                    Margin="0,0,8,0"/>
                            <TextBlock Text="Load More" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <!-- End of Feed Message -->
                    <TextBlock Text="You've reached the end of your feed"
                              Style="{StaticResource MaterialDesignBody2TextBlock}"
                              Foreground="{DynamicResource MaterialDesignBodyLight}"
                              HorizontalAlignment="Center"
                              Margin="16,16,16,32"
                              Visibility="{Binding HasMorePosts, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Inverse}"/>
                </StackPanel>
            </ScrollViewer>

            <!-- Empty State (no posts and no suggested users loaded yet) -->
            <StackPanel VerticalAlignment="Center"
                       HorizontalAlignment="Center"
                       Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Inverse}">
                <materialDesign:PackIcon Kind="PostOutline" 
                                        Width="96" 
                                        Height="96"
                                        Foreground="{DynamicResource MaterialDesignBodyLight}"
                                        HorizontalAlignment="Center"
                                        Opacity="0.5"/>
                <TextBlock Text="No posts yet"
                          Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                          Foreground="{DynamicResource MaterialDesignBodyLight}"
                          HorizontalAlignment="Center"
                          Margin="0,16,0,8"/>
                <TextBlock Text="Follow users to see their posts here"
                          Style="{StaticResource MaterialDesignBody2TextBlock}"
                          Foreground="{DynamicResource MaterialDesignBodyLight}"
                          HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
